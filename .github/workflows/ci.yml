name: CI

on:
  pull_request:
    branches: ["main"]
  push:
    branches: ["main"]

jobs:
  hygiene:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate VERSION format
        run: |
          test -f VERSION
          VERSION_VALUE=$(cat VERSION)
          echo "VERSION=$VERSION_VALUE"
          echo "$VERSION_VALUE" | grep -E '^[0-9]+\.[0-9]+\.[0-9]+$'

      - name: Validate CHANGELOG contains current version
        run: |
          test -f CHANGELOG.md
          VERSION_VALUE=$(cat VERSION)
          grep -q "## \[$VERSION_VALUE\]" CHANGELOG.md

      - name: Validate core version alignment
        run: |
          test -f references/prumo-core.md
          VERSION_VALUE=$(cat VERSION)
          CORE_VERSION=$(grep -Eo '^> \*\*prumo_version: [0-9]+\.[0-9]+\.[0-9]+\*\*$' references/prumo-core.md | sed -E 's/^> \*\*prumo_version: ([0-9]+\.[0-9]+\.[0-9]+)\*\*$/\1/' | head -n1)
          test -n "$CORE_VERSION"
          test "$VERSION_VALUE" = "$CORE_VERSION"
          grep -q "^### v$CORE_VERSION (" references/prumo-core.md

      - name: Validate issue templates exist
        run: |
          test -f .github/ISSUE_TEMPLATE/feature.yml
          test -f .github/ISSUE_TEMPLATE/bug.yml
          test -f .github/ISSUE_TEMPLATE/tech_debt.yml
          test -f .github/ISSUE_TEMPLATE/spike.yml
          test -f .github/ISSUE_TEMPLATE/validation.yml

      - name: Validate docs workflow exists
        run: |
          test -f docs/WORKFLOW.md
          test -f docs/PRODUCT_DEVELOPMENT_GUIDELINES.md

      - name: Validate multi-agent governance hooks
        run: |
          grep -q "compatibility_matrix" .github/ISSUE_TEMPLATE/feature.yml
          grep -q "cross_validation_plan" .github/ISSUE_TEMPLATE/feature.yml
          grep -q "type/validation" .github/pull_request_template.md
          grep -q "agent/gemini" scripts/github/bootstrap_labels.sh
          grep -q "compat/multi-agent" scripts/github/bootstrap_labels.sh

      - name: Briefing smoke tests
        run: |
          test -x scripts/tests/briefing_smoke.sh
          scripts/tests/briefing_smoke.sh

      - name: Validate safe update guardrail exists
        run: |
          test -x scripts/safe_core_update.sh
          grep -q "Garantia de n√£o sobrescrita em updates" README.md
